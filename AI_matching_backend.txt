# SlashData Vehicle Portal - AI Matching Backend Specification

## 1. DATA MODEL EXTENSIONS
To support high-confidence matching, the `ADPMappings` table should be extended:
- `ai_confidence`: SMALLINT UNSIGNED (0-100) - Stores the match score returned by the LLM.
- `matching_engine`: VARCHAR(50) - E.g., 'GEMINI-3-FLASH'.
- `auto_propagated`: BOOLEAN - Set to true if this mapping was applied via a pattern-match rule.

## 2. API ENDPOINTS

### 2.1 Get Unmapped Queue
- **Endpoint**: `GET /api/adp/mappings`
- **Params**: `status=UNMAPPED`, `page`, `size`
- **Output**: DTO containing raw ADP fields (MakeEnDesc, ModelEnDesc, etc).

### 2.2 Submit AI Confirmation
- **Endpoint**: `PUT /api/adp/mappings/{adpId}`
- **Logic**:
  1. Validate that `makeId` and `modelId` exist in master data.
  2. Create/Update mapping record.
  3. **CRITICAL**: Set `reviewed_at = NULL`. All AI-driven matches MUST be reviewed by an Admin.
  4. Log action `AI_MAPPED` in `ADPMappingHistory`.

### 2.3 Bulk AI Match (Server-Side Implementation)
- **Endpoint**: `POST /api/ai/batch-match`
- **Request**: `{ page: number, size: number }`
- **Logic**:
  1. Fetch current unmapped records.
  2. Prompt Gemini: "Context: Vehicle Taxonomy. Match the following raw lines to IDs from this list: [Internal Makes/Models]. Output JSON: { adpId, sdMakeId, sdModelId, score }".
  3. Respond with the array of suggestions.

## 3. PROMPT DESIGN
The backend service must optimize the prompt to reduce token usage by sending the current "Active Manufacturers" list once per batch rather than per line.

## 4. SECURITY & ROLES
- `MAPPING_USER`: Can run analysis and "Confirm" suggestions.
- `MAPPING_ADMIN`: Can "Approve" (Review) the suggestions confirmed by the User.
- `ADMIN`: Full configuration access.