
# SlashData Vehicle Portal - Backend Specification

## 1. Architecture Overview
This document outlines the backend requirements to support the SlashData Vehicle Portal.
- **Runtime**: Node.js with TypeScript (Recommended) or Python (FastAPI/Django).
- **Database**: PostgreSQL.
- **ORM**: Prisma / TypeORM (Node) or SQLAlchemy (Python).
- **Authentication**: JSON Web Tokens (JWT).
- **AI Integration**: Google Gemini API (Server-side proxy).

## 2. API Standards & Conventions
To support the frontend's heavy use of tables, search, and pagination, the API must adhere to these standards:

### 2.1 Pagination
All list endpoints (GET) must support pagination query parameters:
- `page`: Integer (default 1)
- `limit`: Integer (default 20)
- **Response Format**:
  ```json
  {
    "data": [...],
    "meta": {
      "totalItems": 100,
      "totalPages": 5,
      "currentPage": 1
    }
  }
  ```

### 2.2 Search & Filtering
- **Text Search**: Use `q` query parameter for fuzzy search across relevant text fields (e.g., Name, Description, IDs).
- **Sorting**: Use `sortBy` (field name) and `order` ('asc' | 'desc').

---

## 3. Authentication & Security
- **Endpoints**:
  - `POST /api/auth/login`: Accepts `{email, password}`. Returns `{ token, user: { id, name, role, ... } }`.
- **Security**:
  - **Password Hashing**: Use bcrypt or Argon2.
  - **JWT**: Tokens should expire (e.g., 24h).
  - **Role-Based Access Control (RBAC)**:
    - `Admin`: Full access to everything (Vehicle Mgmt, ADP, Admin).
    - `Mapping Admin`: Can access ADP and Vehicle Management sections.
    - `Mapping User`: Can access ADP sections only, excluding Mapping Review.

---

## 4. API Endpoints

### 4.1 Dashboard & Analytics
These endpoints support the `Dashboard.tsx` and `Tracking.tsx` views.

- `GET /api/stats/dashboard`
  - **Response**: 
    ```json
    {
      "counts": { "makes": 10, "models": 50, "types": 5 },
      "adpStatus": { "mapped": 40, "unmapped": 10, "missingModel": 5, "missingMake": 2 }
    }
    ```

- `GET /api/stats/activity`
  - **Query Params**: 
    - `dateFrom` (ISO Date), `dateTo` (ISO Date)
    - `userId` (Filter by contributor)
  - **Response**: 
    ```json
    {
      "recentCounts": { "hour": 5, "day": 20, "week": 100 },
      "userLeaderboard": [{ "id": "1", "name": "Admin", "count": 15 }]
    }
    ```

### 4.2 User Management (Admin Only)
- `GET /api/users`: List users (Pagination + Search).
- `POST /api/users`: Create user (Hash password).
- `PUT /api/users/:id`: Update details.
- `DELETE /api/users/:id`: Soft delete or Hard delete based on policy.

### 4.3 Vehicle Master Data

#### Makes (`/api/makes`)
- `GET`: Supports `q` (Search name).
- `POST`: Create Make.
  - **Validation**: `Name` must be unique (Case-insensitive). Return 409 Conflict if exists.
- `PUT /:id`: Update.
- `DELETE /:id`: **Cascade Delete Logic**.
  - When a Make is deleted, the backend **MUST**:
    1. Delete all `Models` associated with this Make.
    2. Update any `ADPMappings` that reference the deleted Make or its Models:
       - If mapping referenced a deleted model -> Reset to `Unmapped`.
       - If mapping referenced this make (status `MISSING_MODEL`) -> Reset to `Unmapped`.
- `POST /bulk`: Bulk import CSV.
  - **CSV Format**: `Name (En), Name (Ar)`
  - **Logic**: Ignore duplicates based on Name.

#### Vehicle Types (`/api/types`)
- `GET`: Supports `q`.
- `POST`: Create. **Validation**: Name unique.
- `PUT /:id`, `DELETE /:id`.
- `POST /bulk`: Bulk import CSV.
  - **CSV Format**: `Name, Description` (Description can contain commas).

#### Models (`/api/models`)
- `GET`: Supports `q`, `makeId` (Filter by Make).
- `POST`: Create.
  - **Validation**: The combination of (`makeId` + `name`) must be unique.
- `PUT /:id`: Update.
- `DELETE /:id`: **Cascade Logic**.
  - When a Model is deleted, update `ADPMappings` referencing this `modelId` to `Unmapped` (or preserve ADP ID but clear model link).
- `POST /bulk`: Bulk import CSV.
  - **CSV Format**: `Name, Make Name, Type Name`
  - **Logic**: Backend must resolve 'Make Name' and 'Type Name' to IDs. Skip row if not found.

### 4.4 ADP Integration

#### Master Data (`/api/adp/master`)
- `GET`: List raw ADP data.
  - **Search (`q`)**: Match against ADP Make ID, ADP Model ID, En/Ar Descriptions.
- `POST`: Create single entry.
- `DELETE`: Delete entry (Cascade: delete associated mapping).
- `POST /bulk`: Bulk import CSV.
  - **CSV Format**: `MakeID, MakeEn, MakeAr, ModelID, ModelEn, ModelAr, TypeID, TypeEn, TypeAr`

#### Mappings (`/api/adp/mappings`)
- `GET`: List joined Master + Mapping status.
  - **Query Params**:
    - `status`: 'all' | 'mapped' | 'unmapped' | 'issues' | 'pending'
    - `dateFrom`, `dateTo`: Filter by `updatedAt`.
    - `q`: Search against ADP data OR mapped SD Make/Model names.
- `PUT /:adpId`: Create or Update mapping.
  - **Payload**: 
    ```json
    { 
      "status": "MAPPED" | "MISSING_MAKE" | "MISSING_MODEL", 
      "modelId": "uuid" (required if MAPPED),
      "makeId": "uuid" (required if MISSING_MODEL)
    }
    ```
  - **Logic**: Set `updatedAt` = NOW, `updatedBy` = Current User. **Clear** `reviewedAt` (requires re-review).
- `DELETE /:adpId`: Remove mapping (Reset to Unmapped).

#### Mapping Review (`/api/adp/mappings/:adpId/review`)
- `POST`: Mark as reviewed.
  - **Logic**: Set `reviewedAt` = NOW, `reviewedBy` = Current User.

#### Global Make Mapping (`/api/adp/makes/mappings`)
- `GET`: Return list of unique ADP Make IDs and linked SD Makes.
- `POST`: Create/Update global make link.
  - **Payload**: `{ "adpMakeId": "TOY", "sdMakeId": "uuid" }`
  - **Trigger**: Execute **Propagation Logic** (Section 5A).

### 4.5 System / Demo
- `POST /api/admin/reset`: **Reset Data**.
  - **Purpose**: To support the "Reset Demo Data" feature in `Login.tsx`.
  - **Logic**: Truncate all tables and re-seed with `INITIAL_...` constants defined in the application design.

### 4.6 AI Services (Gemini Proxy)
- `POST /api/ai/generate-description`: Proxy for Gemini API.
- `POST /api/ai/suggest-models`: Proxy for Gemini API JSON mode.

---

## 5. Complex Business Logic

### A. ADP Make Mapping Propagation
When a user maps an ADP Make (e.g., "TOY") to an SD Make (e.g., "Toyota") via `/api/adp/makes/mappings`, the backend must:
1. Save the configuration in `ADPMakeMappings`.
2. Find all `ADPMaster` records where `adpMakeId` == "TOY".
3. Iterate through these records in `ADPMappings`:
   - **If Unmapped**: Create a new mapping with status `MISSING_MODEL` and set `makeId` = SD Toyota ID.
   - **If status is `MISSING_MAKE`**: Update status to `MISSING_MODEL` and set `makeId` = SD Toyota ID.
   - **If status is `MISSING_MODEL`**: Update `makeId` to ensure consistency.
   - **If `MAPPED`**: Do nothing (Model is already specifically mapped).
4. **Audit**: Set `updatedBy` to the user who performed the Make Mapping.

### B. Bulk Import Handling
- **Parsing**: Handle varied line endings (\n, \r\n) and comma separation.
- **Transactions**: Use database transactions. If one row fails validation (e.g., invalid Make Name in Model import), log the error but decide whether to fail batch or skip row based on config (Default: Skip row, report error).

---

## 6. Database Schema Reference
(See `database_schema.txt` for SQL definitions)
