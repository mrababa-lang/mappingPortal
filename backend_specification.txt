
# SlashData Vehicle Portal - Backend Specification

## 1. Architecture Overview
- **Framework**: Java 17+ with **Spring Boot 3.x**.
- **Database**: **MySQL 8.0+**.
- **Security**: Spring Security + JWT.
- **AI**: Google Gemini API Integration.

## 2. Data Strategy & ID Generation
- **SlashData Entities (Makes, Models, Types)**:
  - Must use **Database Auto-Increment** (`BIGINT`).
  - API payloads for Creation (`POST`) **must not** include an ID.
  - API responses **must** include the generated ID.
- **ADP Entities**:
  - Use String IDs provided by the source system (or composite keys).
- **Users**:
  - Use **Database Auto-Increment** (`BIGINT`).

## 3. API Endpoints

### 3.1 Authentication
- `POST /api/auth/login`: Returns `{ token: string, user: UserDTO }`. UserDTO includes numeric ID.

### 3.2 Vehicle Management (Auto-Increment IDs)
#### Makes
- `GET /api/makes`: Returns `List<MakeDTO>`.
- `POST /api/makes`: Payload `{ name, nameAr }`. Returns `MakeDTO` (with new ID).
- `POST /api/makes/upload`: Multipart CSV.

#### Models
- `GET /api/models`: Returns `List<ModelDTO>`.
- `POST /api/models`: Payload `{ name, nameAr, makeId(Long), typeId(Long) }`.
- `POST /api/models/upload`: Multipart CSV.
- **Validation**: Ensure `makeId` and `typeId` exist. Check uniqueness of `Name + MakeID`.

#### Types
- `GET /api/types`
- `POST /api/types`

### 3.3 ADP & Mapping
#### ADP Master
- `GET /api/adp/master`: Searchable (Pageable).
- `POST /api/adp/master/upload`: Multipart CSV.

#### Mapping Operations
- `GET /api/adp/mappings`: Filter by status, dates.
- `PUT /api/adp/mappings/{adpId}`:
  - Upsert mapping.
  - Payload: `{ status, makeId(Long), modelId(Long) }`.
  - **Trigger**: Insert record into `ADPMappingHistory` table (`action=UPDATED`).
  - **Reset**: Set `reviewedAt = null` to require re-approval.
- `GET /api/adp/mappings/{adpId}/history`:
  - Returns `List<HistoryEntryDTO>` ordered by timestamp desc.

#### Review Workflow
- `POST /api/adp/mappings/{adpId}/approve`:
  - Update `reviewedAt`, `reviewedBy`.
  - Insert History (`action=REVIEWED`).
- `DELETE /api/adp/mappings/{adpId}/reject`:
  - Delete mapping record.
  - Insert History (`action=REJECTED`).

### 3.4 AI Integration
- `POST /api/ai/suggest-mapping`:
  - Input: `{ description: string }`.
  - Logic:
    1. Fetch list of Makes/Models from DB (cached/optimized).
    2. Call Gemini API with context.
    3. Return `{ makeId: Long, modelId: Long, reasoning: string }`.
- `POST /api/ai/generate-description`:
  - Input: `{ name: string, type: "make"|"type" }`.
  - Returns: `{ description: string }`.

## 4. Business Logic Details

### 4.1 Global Make Mapping
- `POST /api/adp/makes/map`:
  - Payload: `{ adpMakeId: string, sdMakeId: Long }`.
  - Logic:
    1. Save to `ADPMakeMappings`.
    2. Async Job / Transactional Process:
       - Find all `ADPMappings` linked to this `adpMakeId` where `status` is `MISSING_MAKE` or no mapping exists.
       - Update them to `status=MISSING_MODEL`, `makeId=sdMakeId`.
       - Log history for each updated record.

### 4.2 Audit Trail
- Use Spring AOP or Entity Listeners (JPA `@PostPersist`, `@PostUpdate`) to automatically write to `ADPMappingHistory` whenever `ADPMappings` is modified.
- Ensure the `currentUserId` is extracted from the Security Context.

## 5. Security Roles
- `ADMIN`: Full access (Users, Delete operations).
- `MAPPING_ADMIN`: Full access to Data & Mappings (Approve/Reject).
- `MAPPING_USER`: Read Data, Propose Mappings (Update). No Approve/Reject.
