
-- Database Schema for SlashData Vehicle Portal
-- ---------------------------------------------------------

-- 1. Users Table
-- Stores user accounts, roles, and status for access control.
CREATE TABLE Users (
    id VARCHAR(50) PRIMARY KEY, -- UUID recommended
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL, -- Hashed
    role VARCHAR(20) CHECK (role IN ('Admin', 'Mapping Admin', 'Mapping User')),
    status VARCHAR(20) CHECK (status IN ('Active', 'Inactive')),
    last_active TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 2. Vehicle Types Table
-- Classification (e.g., SUV, Sedan).
CREATE TABLE VehicleTypes (
    id VARCHAR(50) PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    name_ar VARCHAR(100), -- Arabic Name
    description TEXT,
    description_ar TEXT -- Arabic Description
);

-- 3. Makes Table
-- Manufacturers (e.g., Toyota).
CREATE TABLE Makes (
    id VARCHAR(50) PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    name_ar VARCHAR(100) -- Arabic Name
);

-- 4. Models Table
-- Models linked to Make and Type.
CREATE TABLE Models (
    id VARCHAR(50) PRIMARY KEY,
    make_id VARCHAR(50) NOT NULL,
    type_id VARCHAR(50) NOT NULL,
    name VARCHAR(100) NOT NULL,
    name_ar VARCHAR(100), -- Arabic Name
    FOREIGN KEY (make_id) REFERENCES Makes(id) ON DELETE CASCADE,
    FOREIGN KEY (type_id) REFERENCES VehicleTypes(id) ON DELETE RESTRICT,
    CONSTRAINT uc_models_make_name UNIQUE (make_id, name)
);

-- 5. ADP Master Data Table
-- Raw import from external system.
CREATE TABLE ADPMaster (
    id VARCHAR(50) PRIMARY KEY,
    adp_make_id VARCHAR(50),
    make_en_desc VARCHAR(200),
    make_ar_desc NVARCHAR(200),
    adp_model_id VARCHAR(50),
    model_en_desc VARCHAR(200),
    model_ar_desc NVARCHAR(200),
    adp_type_id VARCHAR(50),
    type_en_desc VARCHAR(200),
    type_ar_desc NVARCHAR(200)
);

-- 6. ADP Mappings Table
-- The core mapping logic. Links ADP Master ID to SlashData Models/Makes.
-- NOTE: Records in this table represent "Proposed" or "Approved" mappings.
-- If a mapping is Rejected, the record is DELETED from this table, reverting the ADP item to "Unmapped".
CREATE TABLE ADPMappings (
    id VARCHAR(50) PRIMARY KEY,
    adp_id VARCHAR(50) NOT NULL UNIQUE, -- 1-to-1 with ADPMaster
    
    -- Mapping Targets
    status VARCHAR(50) DEFAULT 'MAPPED' CHECK (status IN ('MAPPED', 'MISSING_MAKE', 'MISSING_MODEL')),
    model_id VARCHAR(50), -- Populated if MAPPED
    make_id VARCHAR(50),  -- Populated if MISSING_MODEL (partial map)
    
    -- Audit & Review Workflow
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_by VARCHAR(50),
    
    -- Review Columns: NULL means "Pending Review". NOT NULL means "Approved".
    reviewed_at TIMESTAMP, 
    reviewed_by VARCHAR(50),

    -- Constraints
    FOREIGN KEY (adp_id) REFERENCES ADPMaster(id) ON DELETE CASCADE,
    FOREIGN KEY (model_id) REFERENCES Models(id) ON DELETE SET NULL,
    FOREIGN KEY (make_id) REFERENCES Makes(id) ON DELETE SET NULL,
    FOREIGN KEY (updated_by) REFERENCES Users(id) ON DELETE SET NULL,
    FOREIGN KEY (reviewed_by) REFERENCES Users(id) ON DELETE SET NULL
);

-- 7. ADP Make Mappings Table
-- Global rules for mapping ADP Make Codes to SD Makes.
CREATE TABLE ADPMakeMappings (
    adp_make_id VARCHAR(50) NOT NULL PRIMARY KEY,
    sd_make_id VARCHAR(50) NOT NULL,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (sd_make_id) REFERENCES Makes(id) ON DELETE CASCADE
);

-- Indexes for Performance
-- Optimize Model lookups
CREATE INDEX idx_models_make ON Models(make_id);

-- Optimize Mapping Filtering
CREATE INDEX idx_adp_mapping_status ON ADPMappings(status);
CREATE INDEX idx_adp_mapping_updated ON ADPMappings(updated_at);

-- Optimize Review Workflow (Finding Pending vs Reviewed)
CREATE INDEX idx_adp_mapping_review ON ADPMappings(reviewed_at) WHERE reviewed_at IS NULL;
