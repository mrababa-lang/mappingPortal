
-- Database Schema for SlashData Vehicle Portal
-- Database: MySQL 8.0+

-- ---------------------------------------------------------
-- 1. System Configuration & Jobs
-- ---------------------------------------------------------
CREATE TABLE SystemConfig (
    config_key VARCHAR(50) PRIMARY KEY,
    config_value TEXT,
    description VARCHAR(255),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Initial Seed: 
-- ('enable_ai', 'true'), ('ai_confidence', '70'), ('maintenance_mode', 'false')

CREATE TABLE ImportJobs (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    type ENUM('MAKES', 'MODELS', 'TYPES', 'ADP_MASTER') NOT NULL,
    status ENUM('PENDING', 'PROCESSING', 'COMPLETED', 'FAILED') DEFAULT 'PENDING',
    total_records INT DEFAULT 0,
    processed_records INT DEFAULT 0,
    error_log TEXT,
    created_by BIGINT UNSIGNED,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ---------------------------------------------------------
-- 2. Users Table
-- ---------------------------------------------------------
CREATE TABLE Users (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(100) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(100) NOT NULL,
    role ENUM('Admin', 'Mapping Admin', 'Mapping User') NOT NULL,
    status ENUM('Active', 'Inactive') DEFAULT 'Active',
    last_active TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ---------------------------------------------------------
-- 3. Vehicle Hierarchy Tables
-- ---------------------------------------------------------
CREATE TABLE VehicleTypes (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    name_ar VARCHAR(100),
    description TEXT,
    description_ar TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE Makes (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    name_ar VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE Models (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    make_id BIGINT UNSIGNED NOT NULL,
    type_id BIGINT UNSIGNED NOT NULL,
    name VARCHAR(100) NOT NULL,
    name_ar VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (make_id) REFERENCES Makes(id) ON DELETE CASCADE,
    FOREIGN KEY (type_id) REFERENCES VehicleTypes(id) ON DELETE RESTRICT,
    CONSTRAINT uc_models_make_name UNIQUE (make_id, name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ---------------------------------------------------------
-- 4. ADP Data & Mappings
-- ---------------------------------------------------------
CREATE TABLE ADPMaster (
    id VARCHAR(100) PRIMARY KEY, -- Source System ID
    adp_make_id VARCHAR(50) NOT NULL,
    make_en_desc VARCHAR(200),
    make_ar_desc VARCHAR(200),
    adp_model_id VARCHAR(50) NOT NULL,
    model_en_desc VARCHAR(200),
    model_ar_desc VARCHAR(200),
    adp_type_id VARCHAR(50),
    type_en_desc VARCHAR(200),
    type_ar_desc VARCHAR(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_adp_make (adp_make_id),
    INDEX idx_adp_model (adp_model_id),
    FULLTEXT(make_en_desc, model_en_desc) -- For Keyword Search
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE ADPMappings (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    adp_id VARCHAR(100) NOT NULL UNIQUE,
    
    -- Status Enum matches TypeScript MappingStatus
    status ENUM('MAPPED', 'MISSING_MAKE', 'MISSING_MODEL') DEFAULT 'MAPPED',
    
    -- Foreign Keys to SlashData Entities
    model_id BIGINT UNSIGNED NULL, -- Used if MAPPED
    make_id BIGINT UNSIGNED NULL,  -- Used if MISSING_MODEL (to capture Make)
    
    -- Audit
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    updated_by BIGINT UNSIGNED,
    reviewed_at TIMESTAMP NULL DEFAULT NULL, 
    reviewed_by BIGINT UNSIGNED DEFAULT NULL,

    FOREIGN KEY (adp_id) REFERENCES ADPMaster(id) ON DELETE CASCADE,
    FOREIGN KEY (model_id) REFERENCES Models(id) ON DELETE SET NULL,
    FOREIGN KEY (make_id) REFERENCES Makes(id) ON DELETE SET NULL,
    FOREIGN KEY (updated_by) REFERENCES Users(id) ON DELETE SET NULL,
    FOREIGN KEY (reviewed_by) REFERENCES Users(id) ON DELETE SET NULL,
    
    INDEX idx_status (status),
    INDEX idx_updated_at (updated_at), -- Optimized for Reporting/Time filters
    INDEX idx_reviewed (reviewed_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE ADPMakeMappings (
    adp_make_id VARCHAR(50) NOT NULL PRIMARY KEY,
    sd_make_id BIGINT UNSIGNED NOT NULL,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (sd_make_id) REFERENCES Makes(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE ADPTypeMappings (
    adp_type_id VARCHAR(50) NOT NULL PRIMARY KEY,
    sd_type_id BIGINT UNSIGNED NOT NULL,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (sd_type_id) REFERENCES VehicleTypes(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ---------------------------------------------------------
-- 5. Audit History
-- ---------------------------------------------------------
CREATE TABLE ADPMappingHistory (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    adp_id VARCHAR(100) NOT NULL,
    user_id BIGINT UNSIGNED,
    action ENUM('CREATED', 'UPDATED', 'REVIEWED', 'REJECTED', 'DELETED') NOT NULL,
    details TEXT,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (adp_id) REFERENCES ADPMaster(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES Users(id) ON DELETE SET NULL,
    
    -- Indexes optimized for Dashboard Analytics & Recent Activity
    INDEX idx_history_timestamp (timestamp), -- For trend analysis & recent activity sorting
    INDEX idx_history_user (user_id)         -- For user contribution leaderboards
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
